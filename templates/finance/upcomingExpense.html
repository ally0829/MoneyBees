{% extends "finance/sidebar.html" %} 

{% block style %}
  {% load static %}
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap">
  <link rel="stylesheet" href="{% static 'css/upcomingExpense.css' %}">
  {{ block.super }}
{% endblock %}

{% block main %}
<div class="container">
    <h1>Create upcoming payment!!</h1>
    <div class="upcoming-expense">
        <!-- 左側：表單 -->
        <div class="expense-form">
            <form id="expense-form">
                <label for="date">Select Date</label>
                <input type="date" id="date" name="date" lang="en" required>

                <label for="category">Expense Category</label>
                <select id="category" name="category">
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}                 
                </select>

                <label for="amount">Amount</label>
                <input type="number" id="amount" name="amount" placeholder="$0.0" required>

                <label for="description">Description</label>
                <textarea id="description" name="description" placeholder="Add some description of the expense..."></textarea>

                <div class="form-buttons">
                    <button type="submit" id="save-btn">OK</button>
                    <button type="button" id="delete-btn" class="hidden">Delete</button>
                </div>
            </form>
        </div>

        <!-- 右側：表格 -->
        <div class="expense-list">
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                    <!--  JavaScript  -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 紀錄當前編輯的行 (如果是 null 表示是新增)
    let editingRow = null;

    document.getElementById("expense-form").addEventListener("submit", function(event) {
        event.preventDefault();

        let date = document.getElementById("date").value;
        let category = document.getElementById("category").value;
        let amount = document.getElementById("amount").value;
        let description = document.getElementById("description").value;

        if (editingRow) {
            // edit the row
            editingRow.cells[0].textContent = category;
            editingRow.cells[1].textContent = date;
            editingRow.cells[2].textContent = amount;
            editingRow.cells[3].textContent = description;
            editingRow = null;
        } else {
            // new row
            let tableBody = document.getElementById("expense-table-body");
            let newRow = tableBody.insertRow();
            
            newRow.innerHTML = `
                <td>${category}</td>
                <td>${date}</td>
                <td>${amount}</td>
                <td>${description}</td>
                <td class="actions">
                    <button class="edit-btn">Edit</button>
                    <button class="paid-btn">Paid</button>
                </td>
            `;

            // the button events
            newRow.querySelector(".edit-btn").addEventListener("click", function() {
                document.getElementById("date").value = newRow.cells[1].textContent;
                document.getElementById("category").value = newRow.cells[0].textContent;
                document.getElementById("amount").value = newRow.cells[2].textContent;
                document.getElementById("description").value = newRow.cells[3].textContent;

                editingRow = newRow;
                document.getElementById("delete-btn").classList.remove("hidden");
            });

            // the paid button , not function
            newRow.querySelector(".paid-btn").addEventListener("click", function() {
                alert("Paid functionality not implemented yet.");
            });
        }

        // delete
        document.getElementById("expense-form").reset();
        document.getElementById("delete-btn").classList.add("hidden");
    });

    // the delete button logic
    document.getElementById("delete-btn").addEventListener("click", function() {
        if (editingRow) {
            editingRow.remove();
            editingRow = null;
            document.getElementById("expense-form").reset();
            document.getElementById("delete-btn").classList.add("hidden");
        }
    });
</script>
{% endblock %}
