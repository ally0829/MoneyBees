{% extends "finance/sidebar.html" %} 

{% block style %}
  {% load static %}
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap">
  <link rel="stylesheet" href="{% static 'css/upcomingExpense.css' %}">
  {{ block.super }}
{% endblock %}

{% block main %}
<div class="container">
    <h1>Create upcoming payment!!</h1>
    <div class="upcoming-expense">
        <!-- å·¦å´è¡¨å–® -->
        <div class="expense-form">
            <form id="expense-form">
                <input type="hidden" id="payment-id" name="payment_id"> <!-- store current user ID -->
                
                <label for="date">Select Date</label>
                <input type="date" id="date" name="date" required>

                <label for="category">Expense Category</label>
                <select id="category" name="category">
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}                 
                </select>

                <label for="amount">Amount</label>
                <input type="number" id="amount" name="amount" placeholder="$0.0" required>

                <label for="description">Description</label>
                <textarea id="description" name="description" placeholder="Add some description of the expense..."></textarea>

                <div class="form-buttons">
                    <button type="submit" id="save-btn">OK</button>
                    <button type="button" id="delete-btn" class="hidden">Delete</button>
                </div>
            </form>
        </div>

        <!-- å³å´è¡¨æ ¼ -->
        <div class="expense-list">
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                    {% for payment in payments %}
                    <tr data-id="{{ payment.id }}">
                        <td data-category="{{ payment.category.id }}">{{ payment.category.name }}</td>
                        <td>{{ payment.date }}</td>
                        <td>{{ payment.amount }}</td>
                        <td>{{ payment.description }}</td>
                        <td class="actions">
                            <button class="edit-btn">Edit</button>
                            <button class="paid-btn">Paid</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById("expense-form").addEventListener("submit", savePayment);
        document.querySelectorAll(".edit-btn").forEach(button => button.addEventListener("click", editPayment));
        document.querySelectorAll(".paid-btn").forEach(button => button.addEventListener("click", function () {
            alert("Paid functionality not implemented yet.");
        }));
    }

    async function savePayment(event) {
        event.preventDefault();

        let paymentId = document.getElementById("payment-id").value;
        let date = document.getElementById("date").value;
        let category = document.getElementById("category").value;
        let amount = document.getElementById("amount").value;
        let description = document.getElementById("description").value;

        let url = paymentId ? `/finance/edit-payment/${paymentId}/` : "/finance/add-payment/";
        let method = "POST";

        let response = await fetch(url, {
            method: method,
            body: JSON.stringify({ date, category, amount, description }),
            headers: { "Content-Type": "application/json" }
        });

        let result = await response.json();
        if (result.message) {
            window.location.reload(); // reload page
        }
    }

    function formatDate(dateString) {
        let date = new Date(dateString);
        return date.toISOString().split("T")[0]; // transfer to YYYY-MM-DD
    }

    function editPayment(event) {
        let row = event.target.closest("tr");
        let paymentId = row.getAttribute("data-id");
        let category = row.cells[0].getAttribute("data-category");
        let date = row.cells[1].textContent;
        let amount = row.cells[2].textContent;
        let description = row.cells[3].textContent;

        document.getElementById("payment-id").value = paymentId;
        document.getElementById("category").value = category;
        document.getElementById("date").value = formatDate(date); 
        document.getElementById("amount").value = amount;
        document.getElementById("description").value = description;

        document.getElementById("delete-btn").classList.remove("hidden");
        document.getElementById("delete-btn").addEventListener("click", function () {
            deletePayment(paymentId, row);
        });
    }

    async function deletePayment(paymentId, row) {
        let response = await fetch(`/finance/delete-payment/${paymentId}/`, { method: "DELETE" });
        let result = await response.json();
        if (result.message) {
            row.remove();
            resetForm();//after delete we need to reset 
        }
    }
    function resetForm() {
    document.getElementById("payment-id").value = "";  
    document.getElementById("date").value = "";
    document.getElementById("category").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("description").value = "";
    document.getElementById("delete-btn").classList.add("hidden"); // ðŸ”¹ Delete button hidden
    editingRow = null; // to ensure edit mode disapear
}
</script>
{% endblock %}
