{% extends "finance/sidebar.html" %}
{% load static %}

{% block style %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/homepage.css' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block main %}
<div class="home">
    <section class="spending">
        <div class="actionbtn-container">
            <h2>Spending</h2>
            <button class="btn btn-shadow btn-shadow--black" onclick= "location.href='/finance/expense-record'"><span>View more</span></button>
        </div>
        
        <div id="dateDisplay"></div> <!-- Display current date -->
        <!--<div>Total Spent: <span id="totalSpent">$0.00</span></div>-->

        <div class="chart-info-container">
            <!-- Left: Pie Chart -->
            <div class="chart-container">
                <canvas id="spendingChart"></canvas>
                <div class="chart-center-text" id="chartCenterText">$0</div>
            </div>

            <!-- Right: Category List -->
            <div class="category-info" id="categoryInfo">
                <!-- JavaScript will populate this -->
            </div>
        </div>
    </section>

    <section class="upcoming-payments">
        <div class="header-container">
            <h3>Upcoming Payments</h3>
            <button class="btn btn-shadow btn-shadow--black" onclick="location.href='/finance/upcomingExpense'">
                <span>See All</span>
            </button>
        </div>
        <div class="payment-list" id="upcomingPaymentsList">
            <!-- JavaScript will populate this -->
        </div>
    </section>

    <section class="expense-target">
        <h3>
            Monthly Expense Target
            <button class="btn btn-shadow btn-shadow--black" data-bs-toggle="modal" data-bs-target="#editExpenseTargetModal">
                <span>Edit</span>
            </button>            
        </h3>
        <div class="target-list" id="expenseTargetList">
            <!-- JavaScript will populate this -->
        </div>
    </section>
</div>
<!-- Monthly Expense Target Modal -->
<div class="modal fade" id="editExpenseTargetModal" tabindex="-1" aria-labelledby="editExpenseTargetLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editExpenseTargetLabel">Edit Monthly Expense Target</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="expenseTargetForm">
                    <div class="mb-3">
                        <label for="userSelect" class="form-label">User</label>
                        <select class="form-control" id="userSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="categorySelect" class="form-label">Category</label>
                        <select class="form-control" id="categorySelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="amountInput" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="amountInput" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="monthInput" class="form-label">Month</label>
                        <input type="month" class="form-control" id="monthInput" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveExpenseTarget">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JavaScript & Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Load Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Display the current date
    const today = new Date();
    const formattedDate = today.toLocaleDateString("en-US", { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
    document.getElementById("dateDisplay").textContent = formattedDate;

    // Fetch Spending Summary for chart and categories
    fetch("/api/spending-summary/")
    .then(response => response.json())
    .then(data => {
        console.log("Spending Summary Data:", data);

        // Extract category names, amounts, and percentages
        const labels = data.categories.map(category => category.category);
        const amounts = data.categories.map(category => Number(category.amount));
        const percentages = data.categories.map(category => category.percentage);

        // Update total spent amount
        //document.getElementById("totalSpent").textContent = `$${Number(data.total_spent).toFixed(2)}`;

        // Update center text inside the doughnut chart
        document.getElementById("chartCenterText").textContent = `$${Number(data.total_spent).toLocaleString()}`;

        // Update category list (Right Side)
        const categoryInfo = document.getElementById("categoryInfo");
        categoryInfo.innerHTML = ""; // Clear previous content
        const colors = ['#FFA500', '#FF4500', '#8A2BE2', '#1E90FF', '#FF1493'];

        data.categories.forEach((category, index) => {
            const div = document.createElement("div");
            div.classList.add("category-item");
            div.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <div class="color-box" style="background: ${colors[index % colors.length]}"></div>
                    <span>${category.category}</span>
                </div>
                <span>${category.percentage}%</span>
            `;
            categoryInfo.appendChild(div);
        });

        // Render Doughnut Chart
        const ctx = document.getElementById("spendingChart").getContext("2d");

        // Destroy previous chart instance if it exists
        if (window.myChart) {
            window.myChart.destroy();
        }

        // Create a new Doughnut Chart
        window.myChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{
                    data: amounts,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "80%", // Makes the doughnut thinner
                plugins: {
                    legend: { display: false } // Hide default legend
                }
            }
        });
    })
    .catch(error => console.error("Error fetching spending summary:", error));


    // Fetch Upcoming Payments
    fetch("/api/upcoming-expenses/")
        .then(response => response.json())
        .then(data => {
            console.log("Upcoming Payments Data:", data);

            const upcomingList = document.getElementById("upcomingPaymentsList");
            upcomingList.innerHTML = "";

            if (data.upcoming_expenses.length === 0) {
                upcomingList.innerHTML = "<p>No upcoming payments</p>";
            } else {
                data.upcoming_expenses.forEach(payment => {
                    const div = document.createElement("div");
                    div.classList.add("payment-item");
                    div.innerHTML = `<span>${payment.category}</span> <span>-$${payment.amount} (Due: ${payment.due_date})</span>`;
                    upcomingList.appendChild(div);
                });
            }
        })
        .catch(error => console.error("Error fetching upcoming expenses:", error));

    // Fetch Expense Targets
    fetch("/api/expense-targets/")
        .then(response => response.json())
        .then(data => {
            console.log("Expense Targets Data:", data);

            const targetSection = document.getElementById("expenseTargetList");
            targetSection.innerHTML = "";

            if (data.expense_targets.length === 0) {
                targetSection.innerHTML = "<p>No expense targets set</p>";
            } else {
                data.expense_targets.forEach(target => {
                    const div = document.createElement("div");
                    div.classList.add("target-item");

                    const progressWidth = Math.min((target.current_spent / target.target_amount) * 100, 100);

                    div.innerHTML = `
                        <div class="target-category">${target.category}</div>
                        <div class="target-progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressWidth}%;"></div>
                            </div>
                            <div class="target-amount">$${target.current_spent} / $${target.target_amount}</div>
                        </div>
                    `;
                    
                    targetSection.appendChild(div);
                });
            }
        })
        .catch(error => console.error("Error fetching expense targets:", error));


        document.getElementById("editExpenseTargetModal").addEventListener("show.bs.modal", function () {
        fetch("/api/categories/")
            .then(response => response.json())
            .then(data => {
                const categorySelect = document.getElementById("categorySelect");
                categorySelect.innerHTML = ""; 

                data.categories.forEach(category => {
                    const option = document.createElement("option");
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => console.error("Error loading categories:", error));

        fetch("/api/get-current-user/")
            .then(response => response.json())
            .then(data => {
                document.getElementById("userSelect").innerHTML = `
                    <option value="${data.user_id}" selected>${data.username}</option>
                `;
            })
            .catch(error => console.error("Error loading user:", error));

            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7); 
            const monthInput = document.getElementById("monthInput");
            monthInput.value = currentMonth;
            monthInput.setAttribute("readonly", true); 
    });

    document.getElementById("saveExpenseTarget").addEventListener("click", function () {
        console.log("Save button clicked!"); 

        const user = document.getElementById("userSelect").value;
        const category = document.getElementById("categorySelect").value;
        const amount = document.getElementById("amountInput").value;
        const month = document.getElementById("monthInput").value;

        if (!user || !category || !amount || !month) {
            alert("Please fill in all fields.");
            return;
        }
        fetch("/api/expense-targets/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken() 
            },
            body: JSON.stringify({
                user: user,
                category: category,
                amount: amount,
                month: month
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error("Error:", data.error);
                alert(" Failed to save expense target.");
            } else {
                console.log("Success:", data);
                alert("Expense target saved successfully!");
                location.reload(); 
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to save expense target.");
        });
    });

    function getCSRFToken() {
        return document.cookie.split("; ").find(row => row.startsWith("csrftoken"))?.split("=")[1];
    }
});
</script>
{% endblock %}